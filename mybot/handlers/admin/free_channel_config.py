"""
Handler for free channel configuration by administrators.
"""
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy.ext.asyncio import AsyncSession

from services.free_channel_service import FreeChannelService
from utils.admin_check import is_admin
from utils.message_safety import safe_answer, safe_edit
from keyboards.admin_config_kb import create_free_channel_config_keyboard

router = Router()
logger = logging.getLogger(__name__)


class FreeChannelConfigStates(StatesGroup):
    """Estados para configuraci√≥n del canal gratuito."""
    waiting_for_wait_time = State()
    waiting_for_social_message = State()
    waiting_for_welcome_message = State()


@router.callback_query(F.data == "admin_free_channel_config")
async def show_free_channel_config(callback: CallbackQuery, session: AsyncSession, bot: Bot):
    """Mostrar men√∫ de configuraci√≥n del canal gratuito."""
    if not await is_admin(callback.from_user.id, session):
        await safe_answer(callback, "‚ùå No tienes permisos de administrador.")
        return
    
    free_service = FreeChannelService(session, bot)
    stats = await free_service.get_channel_statistics()
    
    config_text = (
        "üîß **Configuraci√≥n del Canal Gratuito**\n\n"
        f"üìä **Estado Actual:**\n"
        f"‚Ä¢ Canal configurado: {'‚úÖ' if stats['channel_configured'] else '‚ùå'}\n"
        f"‚Ä¢ Tiempo de espera: {stats['wait_time_minutes']} minutos\n"
        f"‚Ä¢ Solicitudes pendientes: {stats['pending_requests']}\n"
        f"‚Ä¢ Total procesadas: {stats['total_processed']}\n"
        f"‚Ä¢ Usuarios con rol FREE: {stats.get('free_users_count', 0)}\n\n"
        "‚öôÔ∏è **Opciones de configuraci√≥n:**"
    )
    
    if stats['channel_configured']:
        config_text += f"\n‚Ä¢ Canal: {stats.get('channel_title', 'N/A')} (ID: {stats['channel_id']})"
    
    keyboard = create_free_channel_config_keyboard(stats)
    await safe_edit(callback, config_text, reply_markup=keyboard)


@router.callback_query(F.data == "config_wait_time")
async def config_wait_time(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Configurar tiempo de espera para aprobaciones."""
    if not await is_admin(callback.from_user.id, session):
        await safe_answer(callback, "‚ùå No tienes permisos de administrador.")
        return
    
    await state.set_state(FreeChannelConfigStates.waiting_for_wait_time)
    
    text = (
        "‚è∞ **Configurar Tiempo de Espera**\n\n"
        "Ingresa el tiempo de espera en minutos antes de aprobar autom√°ticamente las solicitudes.\n\n"
        "üìù **Ejemplos:**\n"
        "‚Ä¢ `0` - Aprobar inmediatamente\n"
        "‚Ä¢ `5` - Esperar 5 minutos\n"
        "‚Ä¢ `60` - Esperar 1 hora\n"
        "‚Ä¢ `1440` - Esperar 24 horas\n\n"
        "Env√≠a el n√∫mero de minutos:"
    )
    
    await safe_edit(callback, text)


@router.message(FreeChannelConfigStates.waiting_for_wait_time)
async def process_wait_time(message: Message, state: FSMContext, session: AsyncSession, bot: Bot):
    """Procesar el tiempo de espera configurado."""
    if not await is_admin(message.from_user.id, session):
        await safe_answer(message, "‚ùå No tienes permisos de administrador.")
        return
    
    try:
        wait_minutes = int(message.text.strip())
        if wait_minutes < 0:
            await safe_answer(message, "‚ùå El tiempo de espera no puede ser negativo.")
            return
        
        free_service = FreeChannelService(session, bot)
        success = await free_service.set_wait_time_minutes(wait_minutes)
        
        if success:
            if wait_minutes == 0:
                response = "‚úÖ Configurado para aprobar solicitudes **inmediatamente**."
            elif wait_minutes < 60:
                response = f"‚úÖ Tiempo de espera configurado a **{wait_minutes} minutos**."
            else:
                hours = wait_minutes // 60
                remaining_minutes = wait_minutes % 60
                if remaining_minutes > 0:
                    time_text = f"{hours} horas y {remaining_minutes} minutos"
                else:
                    time_text = f"{hours} horas"
                response = f"‚úÖ Tiempo de espera configurado a **{time_text}**."
            
            await safe_answer(message, response)
        else:
            await safe_answer(message, "‚ùå Error al configurar el tiempo de espera.")
        
    except ValueError:
        await safe_answer(message, "‚ùå Por favor, ingresa un n√∫mero v√°lido de minutos.")
    
    await state.clear()


@router.callback_query(F.data == "config_social_message")
async def config_social_message(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Configurar mensaje de redes sociales."""
    if not await is_admin(callback.from_user.id, session):
        await safe_answer(callback, "‚ùå No tienes permisos de administrador.")
        return
    
    await state.set_state(FreeChannelConfigStates.waiting_for_social_message)
    
    text = (
        "üì± **Configurar Mensaje de Redes Sociales**\n\n"
        "Este mensaje se env√≠a autom√°ticamente cuando un usuario solicita unirse al canal gratuito.\n\n"
        "üí° **Puedes usar:**\n"
        "‚Ä¢ `{user_name}` - Se reemplaza por el nombre del usuario\n"
        "‚Ä¢ Markdown para formato\n"
        "‚Ä¢ Enlaces a tus redes sociales\n\n"
        "üìù **Env√≠a el mensaje personalizado:**"
    )
    
    await safe_edit(callback, text)


@router.message(FreeChannelConfigStates.waiting_for_social_message)
async def process_social_message(message: Message, state: FSMContext, session: AsyncSession, bot: Bot):
    """Procesar el mensaje de redes sociales configurado."""
    if not await is_admin(message.from_user.id, session):
        await safe_answer(message, "‚ùå No tienes permisos de administrador.")
        return
    
    social_message = message.text.strip()
    if len(social_message) > 4000:
        await safe_answer(message, "‚ùå El mensaje es muy largo. M√°ximo 4000 caracteres.")
        return
    
    free_service = FreeChannelService(session, bot)
    success = await free_service.set_social_media_message(social_message)
    
    if success:
        await safe_answer(message, "‚úÖ Mensaje de redes sociales configurado exitosamente.")
    else:
        await safe_answer(message, "‚ùå Error al configurar el mensaje de redes sociales.")
    
    await state.clear()


@router.callback_query(F.data == "config_welcome_message")
async def config_welcome_message(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Configurar mensaje de bienvenida."""
    if not await is_admin(callback.from_user.id, session):
        await safe_answer(callback, "‚ùå No tienes permisos de administrador.")
        return
    
    await state.set_state(FreeChannelConfigStates.waiting_for_welcome_message)
    
    text = (
        "üéâ **Configurar Mensaje de Bienvenida**\n\n"
        "Este mensaje se env√≠a cuando un usuario es aprobado al canal gratuito.\n\n"
        "üí° **Puedes usar:**\n"
        "‚Ä¢ Markdown para formato\n"
        "‚Ä¢ Emojis para hacer el mensaje m√°s atractivo\n"
        "‚Ä¢ Instrucciones sobre c√≥mo usar el canal\n\n"
        "üìù **Env√≠a el mensaje de bienvenida:**"
    )
    
    await safe_edit(callback, text)


@router.message(FreeChannelConfigStates.waiting_for_welcome_message)
async def process_welcome_message(message: Message, state: FSMContext, session: AsyncSession, bot: Bot):
    """Procesar el mensaje de bienvenida configurado."""
    if not await is_admin(message.from_user.id, session):
        await safe_answer(message, "‚ùå No tienes permisos de administrador.")
        return
    
    welcome_message = message.text.strip()
    if len(welcome_message) > 4000:
        await safe_answer(message, "‚ùå El mensaje es muy largo. M√°ximo 4000 caracteres.")
        return
    
    free_service = FreeChannelService(session, bot)
    success = await free_service.set_welcome_message(welcome_message)
    
    if success:
        await safe_answer(message, "‚úÖ Mensaje de bienvenida configurado exitosamente.")
    else:
        await safe_answer(message, "‚ùå Error al configurar el mensaje de bienvenida.")
    
    await state.clear()


@router.callback_query(F.data == "test_approval_flow")
async def test_approval_flow(callback: CallbackQuery, session: AsyncSession, bot: Bot):
    """Probar el flujo de aprobaci√≥n manualmente."""
    if not await is_admin(callback.from_user.id, session):
        await safe_answer(callback, "‚ùå No tienes permisos de administrador.")
        return
    
    free_service = FreeChannelService(session, bot)
    processed = await free_service.process_pending_requests()
    
    if processed > 0:
        await safe_answer(callback, f"‚úÖ Se procesaron {processed} solicitudes pendientes.")
    else:
        await safe_answer(callback, "‚ÑπÔ∏è No hay solicitudes pendientes para procesar.")


@router.callback_query(F.data == "view_pending_requests")
async def view_pending_requests(callback: CallbackQuery, session: AsyncSession, bot: Bot):
    """Ver solicitudes pendientes detalladas."""
    if not await is_admin(callback.from_user.id, session):
        await safe_answer(callback, "‚ùå No tienes permisos de administrador.")
        return
    
    from database.models import PendingChannelRequest
    from sqlalchemy import select
    from datetime import datetime, timedelta
    
    # Obtener solicitudes pendientes
    stmt = select(PendingChannelRequest).where(
        PendingChannelRequest.approved == False
    ).order_by(PendingChannelRequest.request_timestamp.desc()).limit(10)
    
    result = await session.execute(stmt)
    pending_requests = result.scalars().all()
    
    if not pending_requests:
        await safe_answer(callback, "‚ÑπÔ∏è No hay solicitudes pendientes.")
        return
    
    free_service = FreeChannelService(session, bot)
    wait_minutes = await free_service.get_wait_time_minutes()
    
    text = "üìã **Solicitudes Pendientes** (√∫ltimas 10):\n\n"
    
    for req in pending_requests:
        time_passed = datetime.utcnow() - req.request_timestamp
        time_remaining = timedelta(minutes=wait_minutes) - time_passed
        
        if time_remaining.total_seconds() > 0:
            remaining_minutes = int(time_remaining.total_seconds() / 60)
            status = f"‚è≥ {remaining_minutes}min restantes"
        else:
            status = "‚úÖ Listo para aprobar"
        
        text += (
            f"üë§ Usuario ID: `{req.user_id}`\n"
            f"üìÖ Solicitado: {req.request_timestamp.strftime('%d/%m %H:%M')}\n"
            f"üìä Estado: {status}\n"
            f"üì± Mensaje social: {'‚úÖ' if req.social_media_message_sent else '‚ùå'}\n\n"
        )
    
    await safe_edit(callback, text)